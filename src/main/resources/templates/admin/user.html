<!DOCTYPE html>
<html xmln:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
	<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/latest/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="/style/user.css" />
	<script type="text/javascript">
	     $(function(){
			 
	        $(".search-bar input")
	        .focus(function () {
	        $(".header").addClass("wide");
	        })
	        .blur(function () {
	        $(".header").removeClass("wide");
	        });
	    
            $('.open-modal').click(function(e){
                e.preventDefault();
                $('.main-modal').modal("show");
                $("#btnInsert").css('display', 'none');
                $("#btnUpdate").css('display', 'inline-block');
                $("#btnDelete").css('display', 'inline-block');
            });
            
            $('#addAccount').click(function(e){
                e.preventDefault();
                $('.main-modal').modal("show");
                $("#btnInsert").css('display','inline-block')
                $("#btnUpdate").css('display', 'none');
                $("#btnDelete").css('display', 'none');
                
                $("#pwd").css('display', 'inline-block');
                $("#pwd_txt").html("비밀번호");
                $("#regdate").css('display', 'none');
                $("#regdate_txt").html("");
                
                $("#name_").val("");
                $("#aid").val("");
                $("#nick").val("");
                $("#email").val("");
                $("#level_").val("");
                $("#pwd").val("");
                $("#img").attr("src", "");
                $(".upload-name").val("파일 선택");
            });
            
            
            $(document).ready(function() {
			        $('.pagingName').click(function(e) {
			            e.preventDefault();
			            var pageNum = $(this).text();
			            var column = $("#searchColumn").val();
			            var keyword = $('#search5').val();
			            location.href = 'user?pageNum=' + pageNum + '&column=' + column + '&keyword=' + keyword;
			        });
			   	 });
				
		        function searching(e){
		           let keyword = document.getElementById("search5").value;
		           let column = document.getElementById("searchColumn").value;
		           let pageNum = getParameterByName('pageNum');
		           
		           if (pageNum === null) {
			            pageNum = 1;
			        }
		           console.log('keyword: '+keyword);
		           console.log('column: '+column);
		           console.log('pageNum: '+pageNum);
		           const code = e.code;
				   location.href='user?pageNum=1'+'&column='+column+'&keyword='+keyword;
		        }
		        
		        $('#search5').keydown(function (e) {
						console.log('working');
		            if (e.keyCode == 13) {
						console.log('enter press');
		                e.preventDefault();
		                searching(e);
		            }
		        });
		        
		         // URL에서 파라미터 값을 추출하는 함수
		        function getParameterByName(name) {
		            var url = window.location.href;
		            name = name.replace(/[\[\]]/g, '\\$&');
		            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
		                results = regex.exec(url);
		            if (!results) return null;
		            if (!results[2]) return '';
		            return decodeURIComponent(results[2].replace(/\+/g, ' '));
		        }
        })
    </script> 
</head>
<body style="background-color:black" >

<div class="container-scroller">
    <!-- 사이드바 -->
    <nav id="sidebar-all">
        <ul class="sidebar">
            <li class="sidebar-user">Ketchby</li>
            <li><a href="#">Dashboard</a></li>
            <li><a href="/admin/user">사용자 관리</a></li>
            <li><a href="#">문의 관리</a></li>
            <li><a href="#">공지사항 관리</a></li>
            <li><a href="#">클래스 관리</a></li>
            <li><a href="#">게시판 관리</a></li>
        </ul>
    </nav>
    <div id="page" class="page">

        <!-- 본문 헤더-->
        <div id="page-header">

        </div>
        <div class="main-wrapper">
        <div class="main-table">
            <h2>사용자</h2>
            <p th:text="'총 사용자: '+${member}"></p>
          	<div class="app">
                <div id="search5back">
					
					<!-- 칼럼, 검색어로 검색 -->
					<select id="searchColumn" name="column" th:value="${column}">
						<option th:selected="${column}=='all'">all</option>
						<option th:selected="${column}=='aid'">aid</option>
						<option th:selected="${column}=='email'">email</option>
						<option th:selected="${column}=='name_'">name_</option>
					</select>
                    	<input th:if="${keyword != null}" th:value="${keyword}" id="search5" name="keyword" type="text" size="40" placeholder="Search Aid"/>
                </div>

                 <!-- 테이블 출력 -->
                <table class="table table-dark table-hover">
                	<thead>
                    <tr>
                        <th>아이디</th>
                        <th>이메일</th>
                        <th>이름</th>
                        <th>상세보기</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="m:${list}">
                        <td th:text="${m.aid}"></td>
                        <td th:text="${m.email}"></td>
                        <td th:text="${m.name_}"></td>
                        <td class="open-modal" data-bs-toggle="modal" data-bs-target="#myModal" th:data-value="${m.aid}">
                        	자세히 보기
                        </td>
                    </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-danger" id="addAccount" name="addAccount" 
                 data-bs-toggle="modal" data-bs-target="#myModal">추가</button>
            </div>
            <div class="pagingNumber">
	            <th:block th:each="i:${#numbers.sequence(1, totalPage)}">
					<a th:href="@{/admin/user(pageNum=${pageNum}, column=${column}, keyword=${keyword})}" 
					th:text = "${i }" name="pageNum" id="pageNum" class="pagingName"></a>&nbsp;&nbsp;
				</th:block>
			</div>
        </div>
    </div>
</div>


<!-- The Modal -->
<div class="modal fade" id="myModal">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-xl modal-dialog-centered">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">상세정보</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  	
  		<form id="uploadAccount" role="form" method="post" enctype="multipart/form-data">
        <!-- Modal body -->
	        <div class="modal-body">
	            <table class="modal-table">
	                <tr>
	                    <td>이름</td>
	                    <td>아이디</td>
	                </tr>
	                <tr>
	                    <td>
	                        <input class="modal-input" type="text" name="name_" id="name_">
	                    </td>
	                    <td>
	                        <input class="modal-input" type="text" name="aid" id="aid">
	                    </td>
	                </tr>
	                <tr>
	                    <td>이메일</td>
	                    <td>레벨</td>
	                </tr>
	                <tr>
	                    <td>
	                        <input class="modal-input" type="text" name="email" id="email">
	                    </td>
	                    <td>
	                        <input class="modal-input" type="text" name="level_" id="level_">
	                    </td>
	                </tr>
	                <tr>
						<td>닉네임</td>
	                    
	                    <td>이미지파일</td>
	                </tr>
	                <tr>
	                    <td>
							<input class="modal-input" type="text" name="nick" id="nick">
							
						</td>
						<td class="filebox bs3-primary preview-image">
							<img name="img" id="img" style="width: 50px; height: 50px;">
                            <input class="upload-name" value="파일선택" disabled="disabled" style="width: 200px;">
                            <label for="input_file">업로드</label> 
                            <input type="file" id="input_file" name="uploadFile" class="upload-hidden"> 
                        </td>
	                    
	                </tr>
	                <tr>
	                    <td id="regdate_txt">가입일</td>
	                    <td id="pwd_txt">비밀번호</td>
	                </tr>
	                <tr>
	                    <td>
	                        <span class="modal-input1" name="regdate" id="regdate"></span>
	                    </td>
                        <script type="text/javascript">
                           	$(document).ready(function(){
							  var fileTarget = $('.filebox .upload-hidden');
							
							  fileTarget.on('change', function(){  // 값이 변경되면
							    if(window.FileReader){  // modern browser
							      var filename = $(this)[0].files[0].name;
							    } 
							    else {  // old IE
							      var filename = $(this).val().split('/').pop().split('\\').pop();  // 파일명만 추출
							    }
							    
							    // 추출한 파일명 삽입
							    $(this).siblings('.upload-name').val(filename);
							  });
							  
							//preview image 
						    var imgTarget = $('.preview-image .upload-hidden');
						
						    imgTarget.on('change', function(){
						        var parent = $(this).parent();
						        parent.children('.upload-display').remove();
						
						        if(window.FileReader){
						            //image 파일만
						            if (!$(this)[0].files[0].type.match(/image\//)) return;
						            
						            var reader = new FileReader();
						            reader.onload = function(e){
						                var src = e.target.result;
						                parent.prepend('<div class="upload-display"><div class="upload-thumb-wrap"><img src="'+src+'" class="upload-thumb"></div></div>');
						            }
						            reader.readAsDataURL($(this)[0].files[0]);
						        }
						
						        else {
						            $(this)[0].select();
						            $(this)[0].blur();
						            var imgSrc = document.selection.createRange().text;
						            parent.prepend('<div class="upload-display"><div class="upload-thumb-wrap"><img class="upload-thumb"></div></div>');
						
						            var img = $(this).siblings('.upload-display').find('img');
						            img[0].style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(enable='true',sizingMethod='scale',src=\""+imgSrc+"\")";        
						        }
						    });  
							}); 
                        	</script>
                        <td>
	                        <input class="modal-input" type="text" name="pwd" id="pwd">
	                    </td>
	                    
	                </tr>
	            </table>
				
	        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
        </form>
        <button type="button" class="btn btn-danger" id="btnInsert" name="btnInsert" data-bs-dismiss="modal">추가</button>
        <button type="button" class="btn btn-danger" id="btnUpdate" name="btnUpdate" data-bs-dismiss="modal">수정</button>
        <button type="button" class="btn btn-danger" id="btnDelete" name="btnDelete" data-bs-dismiss="modal">삭제</button>
        <button type="button" class="btn btn-danger" id="btnClose" name="btnClose" data-bs-dismiss="modal">닫기</button>
          
        </div>
  		<script type="text/javascript">
			$(".open-modal").click(function(){
				console.log(this);
				var aid = $(this).data('value');
				console.log(aid);
				$.ajax({
					url: '/admin/detail',
					data: {
						aid:aid
					},
					success: function(a){
						console.log(a.aid);
						console.log(a);
						$("#pwd").css('display', 'none');
						$("#regdate").css('display', 'inline-block');
						$("#pwd_txt").html("");
						$("#aid").val(a.aid);
						$("#aid").css('readonly', 'readonly');
						$("#name_").val(a.name_);
						$("#nick").val(a.nick);
						$("#level_").val(a.level_);
						$("#email").val(a.email);
						
						$("#regdate").html(a.regdate);
						$("#regdate_txt").html("가입일");
						$(".upload-name").val(a.img);
						$("#img").attr('src','/profile/'+a.img);
					}
				})
			})
			  
			$("#btnInsert").click(function(){
				let data = new FormData(document.getElementById("uploadAccount"));
				console.log(data);
				$.ajax({
					url: "/admin/insert",
					type: "post",
					processData: false,
					contentType: false,
					data: data,
					success: function(r){
						alert(r);
					}, error: function(){
						alert("추가에 실패하였습니다.");
					}
				});
				
			})  
			
			$("#btnUpdate").click(function(){
				var formData = new FormData;
				formData.append('aid', $("#aid").val());
				formData.append("name_", $("#name_").val());
				formData.append('level_', $("#level_").val());
				formData.append('nick', $("#nick").val());
				formData.append("email", $("#email").val());
				formData.append('uploadFile', $("#input_file")[0].files[0]);
				console.log('formdata: '+formdata);
				
				var aid = $("#aid").val();
				var name_ = $('#name_').val();
				var level_ = $('#level_').val();
				var nick = $("#nick").val();
				var email = $('#email').val();
				var uploadFile = $("#input_file").val();
				$.ajax({
					url: '/admin/update',
					data: formData,
					success: function(a){
						console.log(a);
						alert("수정 완료하였습니다.");
						location.href = '/admin/user';
					},error: function(){
						alert('수정 실패했습니다.');
					}
				})
			})
			
			$("#btnDelete").click(function(){
				var aid = $("#aid").val();
				if(confirm('정말로 삭제할까요?')==true){
					$.ajax({
						url: '/admin/delete',
						data: {
							aid: aid
						},
						success: function(){
							alert("삭제 완료했습니다.");
							location.href = '/admin/user';
						},error: function(){
						alert('삭제 실패했습니다.');
					}
					})
				}
			})
		</script>
      </div>
    </div>
  </div>
</body>
</html>